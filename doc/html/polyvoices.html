<HTML>
<HEAD>
<TITLE>The Synthesis ToolKit in C++ (STK)</TITLE>
<LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
</HEAD>
<BODY BGCOLOR="#FFFFFF">
<CENTER>
<img src="princeton.gif"> &nbsp; <img src="ccrma.gif"> &nbsp; <img src="mcgill.gif"><P>
<a class="qindex" href="index.html">Home</a> &nbsp; <a class="qindex" href="information.html">Information</a> &nbsp; <a class="qindex" href="classes.html">Classes</a> &nbsp; <a class="qindex" href="download.html">Download</a> &nbsp; <a class="qindex" href="usage.html">Usage</a> &nbsp; <a class="qindex" href="maillist.html">Mail List</a> &nbsp; <a class="qindex" href="system.html">Requirements</a> &nbsp; <a class="qindex" href="links.html">Links</a> &nbsp; <a class="qindex" href="tutorial.html">Tutorial</a></CENTER>
<HR>
<!-- Generated by Doxygen 1.3.4 -->
<h1><a class="anchor" name="polyvoices">Voice Management</a></h1>The previous tutorial chapters were concerned only with monophonic ToolKit instrument playback and control. At this point, it should be relatively clear that one can instantiate multiple instruments and perhaps sum together their sounds or even direct their sounds to separate output channels. It is less clear how one might go about controlling a group of instruments. The <a class="el" href="classVoicer.html">Voicer</a> class is designed to serve just this purpose.<p>
The STK <a class="el" href="classVoicer.html">Voicer</a> class is a relatively simple voice manager. The user can dynamically add and delete instruments from its "control", with the option of controlling specific instruments via unique note tags and/or grouping sets of instruments via a "channel" number. All sounding instrument outputs are summed and returned via the <code>tick()</code> function. The <a class="el" href="classVoicer.html">Voicer</a> class responds to noteOn, noteOff, setFrequency, pitchBend, and controlChange messages, automatically assigning incoming messages to the voices in its control. When all voices are sounding and a new noteOn is encountered, the <a class="el" href="classVoicer.html">Voicer</a> interrupts the oldest sounding voice. The user is responsible for creating and deleting all instrument instances.<p>
In the following example, we modify the <code>controlbee.cpp</code> program to make use of three <a class="el" href="classBeeThree.html">BeeThree</a> instruments, all controlled using a <a class="el" href="classVoicer.html">Voicer</a>.<p>
<div class="fragment"><pre><span class="comment">// threebees.cpp</span>

<span class="preprocessor">#include "BeeThree.h"</span>
<span class="preprocessor">#include "RtWvOut.h"</span>
<span class="preprocessor">#include "Messager.h"</span>
<span class="preprocessor">#include "Voicer.h"</span>
<span class="preprocessor">#include "SKINI.msg"</span>

<span class="keywordtype">int</span> main()
{
  <span class="comment">// Set the global sample rate before creating class instances.</span>
  <a class="code" href="classStk.html#e1">Stk::setSampleRate</a>( 44100.0 );

  <span class="keywordtype">int</span> i;
  <a class="code" href="classRtWvOut.html">RtWvOut</a> *output = 0;
  <a class="code" href="classMessager.html">Messager</a> *messager = 0;
  <a class="code" href="classVoicer.html">Voicer</a> *voicer = 0;
  <span class="keywordtype">bool</span> done = FALSE;
  <a class="code" href="classInstrmnt.html">Instrmnt</a> *instrument[3];
  <span class="keywordflow">for</span> ( i=0; i&lt;3; i++ ) instrument[i] = 0;

  <span class="keywordflow">try</span> {
    <span class="comment">// Define and load the BeeThree instruments</span>
    <span class="keywordflow">for</span> ( i=0; i&lt;3; i++ )
      instrument[i] = <span class="keyword">new</span> <a class="code" href="classBeeThree.html">BeeThree</a>();

    <span class="comment">// Define and open the default realtime output device for one-channel playback</span>
    output = <span class="keyword">new</span> <a class="code" href="classRtWvOut.html">RtWvOut</a>(1);
  }
  <span class="keywordflow">catch</span> (<a class="code" href="classStkError.html">StkError</a> &amp;) {
    <span class="keywordflow">goto</span> cleanup;
  }

  <span class="keywordflow">try</span> {
    <span class="comment">// Create a Messager instance to read from a redirected SKINI scorefile.</span>
    messager = <span class="keyword">new</span> <a class="code" href="classMessager.html">Messager</a>();
  }
  <span class="keywordflow">catch</span> (<a class="code" href="classStkError.html">StkError</a> &amp;) {
    <span class="keywordflow">goto</span> cleanup;
  }

  <span class="comment">// Instantiate the voicer for a maximum of three voices.</span>
  voicer = <span class="keyword">new</span> <a class="code" href="classVoicer.html">Voicer</a>( 3 );
  <span class="keywordflow">for</span> ( i=0; i&lt;3; i++ )
    voicer-&gt;<a class="code" href="classVoicer.html#a2">addInstrument</a>( instrument[i] );

  <span class="comment">// Play the instrument until the end of the scorefile.</span>
  <span class="keywordtype">int</span> nTicks, type;
  MY_FLOAT byte2, byte3;
  <span class="keywordflow">while</span> (!done) {

    <span class="comment">// Look for new messages and return a delta time (in samples).</span>
    type = messager-&gt;<a class="code" href="classMessager.html#a2">nextMessage</a>();
    <span class="keywordflow">if</span> (type &lt; 0)
      done = TRUE;

    nTicks = messager-&gt;<a class="code" href="classMessager.html#a4">getDelta</a>();
    <span class="keywordflow">try</span> {
      <span class="keywordflow">for</span> ( i=0; i&lt;nTicks; i++ )
        output-&gt;<a class="code" href="classRtWvOut.html#a6">tick</a>( voicer-&gt;<a class="code" href="classVoicer.html#a14">tick</a>() );
    }
    <span class="keywordflow">catch</span> (<a class="code" href="classStkError.html">StkError</a> &amp;) {
      <span class="keywordflow">goto</span> cleanup;
    }

    <span class="keywordflow">if</span> ( type &gt; 0 ) {
      <span class="comment">// Process the new control message.</span>
      byte2 = messager-&gt;<a class="code" href="classMessager.html#a6">getByteTwo</a>();
      byte3 = messager-&gt;<a class="code" href="classMessager.html#a7">getByteThree</a>();

      <span class="keywordflow">switch</span>(type) {

      <span class="keywordflow">case</span> __SK_NoteOn_:
        voicer-&gt;<a class="code" href="classVoicer.html#a4">noteOn</a>( byte2, byte3 );
        <span class="keywordflow">break</span>;

      <span class="keywordflow">case</span> __SK_NoteOff_:
        voicer-&gt;<a class="code" href="classVoicer.html#a5">noteOff</a>( byte2, byte3 );
        <span class="keywordflow">break</span>;

      <span class="keywordflow">case</span> __SK_ControlChange_:
        voicer-&gt;<a class="code" href="classVoicer.html#a11">controlChange</a>( (<span class="keywordtype">int</span>) byte2, byte3 );
        <span class="keywordflow">break</span>;

      <span class="keywordflow">case</span> __SK_AfterTouch_:
        voicer-&gt;<a class="code" href="classVoicer.html#a11">controlChange</a>( 128, byte2 );
        <span class="keywordflow">break</span>;
      }
    }
  }

 cleanup:
  <span class="keywordflow">for</span> ( i=0; i&lt;3; i++ ) <span class="keyword">delete</span> instrument[i];
  <span class="keyword">delete</span> output;
  <span class="keyword">delete</span> messager;
  <span class="keyword">delete</span> voicer;

  <span class="keywordflow">return</span> 0;
}
</pre></div><p>
Assuming the program is compiled as <code>threebees</code>, the three-voice <a class="el" href="classSKINI.html">SKINI</a> scorefile <a href="tutorial/bachfugue.ski"><code>bachfugue.ski</code></a> (also located in the <code>scores</code> directory with the examples) could be redirected to the program as:<p>
<div class="fragment"><pre>threebees &lt; bachfugue.ski
</pre></div><p>
For more fun, surf to <a href="http://kern.humdrum.net/">Kern Scores</a> for a huge assortment of other scorefiles which can be downloaded in the <a class="el" href="classSKINI.html">SKINI</a> format.<p>
Another easy extension would be to use the <code>STK_MIDI</code> constructor argument to the <a class="el" href="classMessager.html">Messager</a> class and then play the instruments via a MIDI keyboard.<p>
[<a href="tutorial.html">Main tutorial page</a>] <HR>

<table>
  <tr><td><A HREF="http://www-ccrma.stanford.edu/software/stk/"><I>The Synthesis ToolKit in C++ (STK)</I></A></td></tr>
  <tr><td>&copy;1995-2004 Perry R. Cook and Gary P. Scavone. All Rights Reserved.</td></tr>
</table>

</BODY>
</HTML>
